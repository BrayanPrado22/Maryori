function solicitarPermisoNotificaciones(){"Notification"in window?"granted"===Notification.permission?(console.log("Notificaciones ya est√°n activadas."),suscribirseNotificacionesPush()):"default"===Notification.permission&&Notification.requestPermission().then(e=>{"granted"===e?(console.log("Notificaciones activadas."),suscribirseNotificacionesPush()):console.warn("El usuario bloque√≥ las notificaciones.")}).catch(e=>console.error("Error solicitando permisos de notificaci√≥n:",e)):console.warn("Las notificaciones no son compatibles con este navegador.")}function suscribirseNotificacionesPush(){navigator.serviceWorker.ready.then(e=>e.pushManager.getSubscription()).then(e=>e?localStorage.getItem("suscripcionEndpoint")===e.endpoint?void console.log("La suscripci√≥n ya fue enviada. No se reenviar√°."):(console.log("Enviando nueva suscripci√≥n al servidor..."),enviarSuscripcionAlServidor(e)):navigator.serviceWorker.ready.then(e=>e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:urlBase64ToUint8Array("BHgx1opoEI_6M1HnUSsdPhbxxwanb28ZZi0Kq_vSGebymi1pZrOJsMEUFVwnNX8usXd4K3V0CKqG4Nl2c0hkFzA")})).then(e=>(console.log("Nueva suscripci√≥n creada."),enviarSuscripcionAlServidor(e)))).catch(e=>console.error("Error en la suscripci√≥n push:",e))}function enviarSuscripcionAlServidor(o){return fetch("/guardar-suscripcion.php",{method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{console.log("Respuesta del servidor:",e),"Suscripci√≥n guardada correctamente"===e.message&&localStorage.setItem("suscripcionEndpoint",o.endpoint)}).catch(e=>console.error("Error enviando la suscripci√≥n:",e))}function urlBase64ToUint8Array(e){e=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),e=atob(e);return new Uint8Array([...e].map(e=>e.charCodeAt(0)))}"registerProtocolHandler"in navigator&&(navigator.registerProtocolHandler("web+dedicame",window.location.origin+"/protocolo.php?url=%s","Dedicame"),console.log("Protocolo web+dedicame registrado correctamente.")),solicitarPermisoNotificaciones(),fetch("/sw-version.php").then(e=>e.text()).then(e=>{"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js?v="+e).then(o=>{console.log("‚úÖ Service Worker registrado con versi√≥n:",e),o.waiting&&o.waiting.postMessage({action:"skipWaiting"}),o.addEventListener("updatefound",()=>{let e=o.installing;e.addEventListener("statechange",()=>{"installed"===e.state&&navigator.serviceWorker.controller&&(e.postMessage({action:"skipWaiting"}),console.log("üîÑ Nueva versi√≥n disponible. Recargando..."),location.reload())})}),"SyncManager"in window&&navigator.serviceWorker.ready.then(e=>e.sync.register("syncOfflineData")).then(()=>{console.log("üì° Sincronizaci√≥n en segundo plano registrada")}).catch(e=>{console.error("‚ùå Error al registrar la sincronizaci√≥n en segundo plano",e)})}).catch(e=>console.error("‚ùå Error registrando Service Worker",e))}).catch(e=>console.error("‚ùå Error obteniendo la versi√≥n del Service Worker",e));let deferredPrompt;function instalarPWA(){deferredPrompt&&(deferredPrompt.prompt(),deferredPrompt.userChoice.then(e=>{"accepted"===e.outcome?(console.log("Usuario instal√≥ la PWA"),localStorage.setItem("pwa_instalada","true")):console.log("Usuario cancel√≥ la instalaci√≥n"),deferredPrompt=null}))}function mostrarNotificacion(o,n){"granted"===Notification.permission&&navigator.serviceWorker?navigator.serviceWorker.ready.then(e=>{e.showNotification(o,{body:n,icon:"/imagenes/iconos/192x192.png",data:{url:location.origin}})}):console.warn("Las notificaciones no est√°n activadas o Service Worker no est√° disponible.")}window.addEventListener("beforeinstallprompt",e=>{deferredPrompt=e,console.log("Evento beforeinstallprompt detectado. Mostrando bot√≥n de instalaci√≥n...");e=document.getElementById("btnInstalarPWA");e&&!localStorage.getItem("pwa_instalada")&&(e.style.display="block")}),window.addEventListener("appinstalled",()=>{console.log("PWA instalada"),localStorage.setItem("pwa_instalada","true");var e=document.getElementById("btnInstalarPWA");e&&(e.style.display="none")}),document.addEventListener("DOMContentLoaded",()=>{var e;"true"===localStorage.getItem("pwa_instalada")&&(e=document.getElementById("btnInstalarPWA"))&&(e.style.display="none")}),navigator.serviceWorker.addEventListener("message",e=>{var o;e.data&&"checkOfflineStatus"===e.data.action&&(o=!navigator.onLine,e.source.postMessage({action:"offlineStatus",value:o}))}),window.addEventListener("online",()=>{console.log("Conexi√≥n restablecida. Mostrando notificaci√≥n."),mostrarNotificacion("¬°Est√°s de vuelta en l√≠nea!","Tu conexi√≥n se ha restablecido.")});